<!-- Automatic Table of Contents Generator -->
{% if include.scope %}
  {% assign toc_content = include.scope %}
{% else %}
  {% assign toc_content = content %}
{% endif %}

{% if include.min_level %}
  {% assign min_level = include.min_level | plus: 0 %}
{% else %}
  {% assign min_level = 2 %}
{% endif %}

{% if include.max_level %}
  {% assign max_level = include.max_level | plus: 0 %}
{% else %}
  {% assign max_level = 4 %}
{% endif %}

{% assign toc_class = include.class | default: "toc-auto" %}
{% assign toc_title = include.title | default: "Table of Contents" %}

<!-- Extract headings from content -->
{% assign headings = "" | split: "" %}
{% assign heading_pattern = '<h([2-6])[^>]*id="([^"]*)"[^>]*>([^<]*)</h[2-6]>' %}

<!-- Generate TOC HTML -->
<div class="{{ toc_class }}">
  {% if toc_title %}
    <h3 class="toc-title">{{ toc_title }}</h3>
  {% endif %}
  
  <nav class="toc-nav" role="navigation" aria-label="Table of contents">
    <ul class="toc-list" id="toc-list">
      <!-- TOC will be generated by JavaScript -->
    </ul>
  </nav>
</div>

<style>
.toc-auto {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 20px;
  margin: 20px 0;
  max-width: 300px;
}

.toc-auto.sticky {
  position: sticky;
  top: 20px;
  float: right;
  margin: 0 0 20px 20px;
}

.toc-title {
  margin: 0 0 15px 0;
  font-size: 16px;
  color: #333;
  border-bottom: 1px solid #dee2e6;
  padding-bottom: 8px;
}

.toc-list {
  list-style: none;
  margin: 0;
  padding: 0;
  line-height: 1.4;
}

.toc-list li {
  margin: 0;
  padding: 0;
}

.toc-list a {
  display: block;
  padding: 4px 0;
  color: #666;
  text-decoration: none;
  font-size: 14px;
  transition: color 0.3s ease;
  border-left: 3px solid transparent;
  padding-left: 8px;
}

.toc-list a:hover {
  color: #0066cc;
  border-left-color: #0066cc;
}

.toc-list a.active {
  color: #0066cc;
  font-weight: bold;
  border-left-color: #0066cc;
  background: rgba(0, 102, 204, 0.1);
}

/* Nested levels */
.toc-list .toc-level-3 {
  padding-left: 20px;
  font-size: 13px;
}

.toc-list .toc-level-4 {
  padding-left: 35px;
  font-size: 12px;
}

.toc-list .toc-level-5 {
  padding-left: 50px;
  font-size: 12px;
}

.toc-list .toc-level-6 {
  padding-left: 65px;
  font-size: 11px;
}

/* Responsive behavior */
@media (max-width: 768px) {
  .toc-auto.sticky {
    position: static;
    float: none;
    margin: 20px 0;
    max-width: none;
  }
}

/* Print styles */
@media print {
  .toc-auto {
    display: none;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  generateTableOfContents();
  setupTocScrollSpy();
});

function generateTableOfContents() {
  const tocList = document.getElementById('toc-list');
  if (!tocList) return;

  const minLevel = {{ min_level }};
  const maxLevel = {{ max_level }};
  
  // Find all headings in the content area
  const contentArea = document.querySelector('.content') || document.querySelector('main') || document.body;
  const headings = contentArea.querySelectorAll('h2, h3, h4, h5, h6');
  
  if (headings.length === 0) {
    // Hide TOC if no headings found
    const tocContainer = tocList.closest('.toc-auto');
    if (tocContainer) {
      tocContainer.style.display = 'none';
    }
    return;
  }

  let tocHTML = '';
  let currentLevel = minLevel;

  headings.forEach((heading, index) => {
    const level = parseInt(heading.tagName.charAt(1));
    
    // Skip headings outside our level range
    if (level < minLevel || level > maxLevel) return;
    
    // Generate ID if heading doesn't have one
    let id = heading.id;
    if (!id) {
      id = generateHeadingId(heading.textContent);
      heading.id = id;
    }
    
    const text = heading.textContent.trim();
    
    // Handle nesting
    if (level > currentLevel) {
      // Opening nested levels
      for (let i = currentLevel; i < level; i++) {
        tocHTML += '<ul class="toc-sublist">';
      }
    } else if (level < currentLevel) {
      // Closing nested levels
      for (let i = level; i < currentLevel; i++) {
        tocHTML += '</ul>';
      }
    }
    
    tocHTML += `<li><a href="#${id}" class="toc-link toc-level-${level}" data-level="${level}">${text}</a></li>`;
    currentLevel = level;
  });
  
  // Close any remaining open lists
  for (let i = minLevel; i < currentLevel; i++) {
    tocHTML += '</ul>';
  }
  
  tocList.innerHTML = tocHTML;
  
  // Add smooth scrolling
  const tocLinks = tocList.querySelectorAll('a');
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const targetElement = document.getElementById(targetId);
      
      if (targetElement) {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
        
        // Update URL without triggering scroll
        if (history.pushState) {
          history.pushState(null, null, `#${targetId}`);
        }
      }
    });
  });
}

function generateHeadingId(text) {
  return text
    .toLowerCase()
    .replace(/[^\w\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/--+/g, '-')
    .replace(/^-+|-+$/g, '');
}

function setupTocScrollSpy() {
  const tocLinks = document.querySelectorAll('.toc-link');
  if (tocLinks.length === 0) return;

  const headings = Array.from(tocLinks).map(link => {
    const id = link.getAttribute('href').substring(1);
    return document.getElementById(id);
  }).filter(Boolean);

  if (headings.length === 0) return;

  function updateActiveLink() {
    const scrollPosition = window.scrollY + 100; // Offset for better UX
    let activeHeading = null;
    
    // Find the current heading
    headings.forEach(heading => {
      if (heading.offsetTop <= scrollPosition) {
        activeHeading = heading;
      }
    });
    
    // Update active states
    tocLinks.forEach(link => {
      link.classList.remove('active');
    });
    
    if (activeHeading) {
      const activeLink = document.querySelector(`.toc-link[href="#${activeHeading.id}"]`);
      if (activeLink) {
        activeLink.classList.add('active');
      }
    }
  }

  // Throttled scroll handler
  let ticking = false;
  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(() => {
        updateActiveLink();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', onScroll);
  updateActiveLink(); // Initial call
}
</script>